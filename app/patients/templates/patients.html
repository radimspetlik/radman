{% extends "base.html" %}

{% block title %}Patient Registration{% endblock %}

{% block content %}
  <h1>Register Patients for PET Scanner</h1>

  <h2>Add New Patient</h2>
  <form method="post" action="{{ url_for('patients.manage_patients') }}">
    <div style="display: flex; gap: 20px; align-items: flex-start;">
        <div>
            <label for="surname">Surname:</label>
            <input type="text" name="surname" id="surname" required>
        </div>
        <div>
            <label for="given_name">Name:</label>
            <input type="text" name="given_name" id="given_name" required>
        </div>
        <div>
            <label for="identification">Identification Number:</label>
            <input type="text" name="identification" id="identification" required>
        </div>
    </div>

    <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 10px;">
        <div>
            <label for="weight">Weight (kg):</label>
            <input type="number" step="any" name="weight" id="weight" required oninput="computeDose()">
        </div>
        <div>
            <label for="dosing_scheme">Dosing Scheme:</label>
            <select name="dosing_scheme" id="dosing_scheme" onchange="computeDose()" required>
              <option value="">-- Select a dosing scheme --</option>
              {% for scheme in dosing_schemes %}
                <option value="{{ scheme.RowKey }}"
                        data-dosevalue="{{ scheme.DoseValue }}"
                        data-dosetype="{{ scheme.DoseType }}">
                  {{ scheme.Name }}
                </option>
              {% endfor %}
            </select>
        </div>
    </div>

    <p>
      <strong>Computed Administered Dose:</strong>
      <span id="administered_dose_display">0 MBq</span>
    </p>

    <button type="submit">Add Patient</button>
  </form>

  <h2>Registered Patients</h2>
  {% if patients %}
    <table border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>Surname</th>
          <th>Name</th>
          <th>Identification</th>
          <th>Weight (kg)</th>
          <th>Dosing Scheme</th>
          <th>Administered Dose (MBq)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for patient in patients %}
          <tr>
            <td>{{ patient.Surname }}</td>
            <td>{{ patient.GivenName }}</td>
            <td>{{ patient.Identification }}</td>
            <td>{{ patient.Weight }}</td>
            <td>{{ dosing_scheme_by_rowkey[patient.DosingSchemeID]['Name'] }}</td>
            <td>{{ patient.AdministeredDose }}</td>
            <td>
                <div style="display: flex; gap: 5px; align-items: stretch;">
                    <div style="flex: 1;">
                        <a href="{{ url_for('patients.edit_patient', row_key=patient.RowKey) }}" style="display: block; width: 100%;">
                            <button type="button"
                                class="btn btn-edit"
                                style="width: 100%;">Edit</button>
                        </a>
                    </div>
                    <div style="flex: 1;">
                      <form method="post" action="{{ url_for('patients.delete_patient', row_key=patient.RowKey) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this patient?');">
                        <button type="submit" class="btn btn-delete" style="width: 100%;">Delete</button>
                      </form>
                    </div>
                </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No patients registered yet.</p>
  {% endif %}

  <h2>Actions</h2>
  <div style="display: flex; gap: 20px; align-items: stretch;">
    <div style="flex: 1;">
      <form method="post" action="{{ url_for('patients.clear_patients') }}" style="width: 100%;">
        <button type="submit"
                onclick="return confirm('Are you sure you want to clear all patients?');"
                class="btn btn-delete"
                style="width: 100%;">Clear Patients</button>
      </form>
    </div>
    <div style="flex: 1;">
      <a href="{{ url_for('optim.do_it') }}" style="display: block; width: 100%;">
        <button type="button"
                class="btn btn-optimize"
                style="width: 100%;">Optimize</button>
      </a>
    </div>
  </div>

  <script>
    function computeDose() {
      var select = document.getElementById("dosing_scheme");
      var weightInput = document.getElementById("weight");
      var display = document.getElementById("administered_dose_display");

      var weight = parseFloat(weightInput.value);
      if (isNaN(weight)) {
        weight = 0;
      }

      var selectedOption = select.options[select.selectedIndex];
      if (!selectedOption || selectedOption.value === "") {
        display.textContent = "0 MBq";
        return;
      }

      var doseValue = parseFloat(selectedOption.getAttribute("data-dosevalue"));
      var doseType = selectedOption.getAttribute("data-dosetype");

      var administered = 0;
      if (doseType === "per_kg") {
        administered = doseValue * weight;
      } else {
        administered = doseValue;
      }

      display.textContent = administered.toFixed(2) + " MBq";
    }
  </script>
{% endblock %}
